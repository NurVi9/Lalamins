<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luminox â€” Full CMS Activated</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --bg: #f4f7fa; --card: #ffffff; --sidebar-bg: #ffffff; --text: #1a202c; --muted: #64748b; --accent: #3b82f6; --accent-dark: #2563eb; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --ring: rgba(59, 130, 246, 0.4); --header-bg: rgba(255, 255, 255, 0.8); --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
    }
    [data-theme="dark"] {
      --bg: #0d1117; --card: #161b22; --sidebar-bg: #161b22; --text: #c9d1d9; --muted: #8b949e; --accent: #58a6ff; --accent-dark: #388bfd; --header-bg: rgba(22, 27, 34, 0.8); --border: #30363d; --ring: rgba(88, 166, 255, 0.35);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
    body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; transition: background .2s, color .2s; }
    .hidden { display: none !important; }
    .app-layout { display: flex; transition: margin-left .3s ease; }
    .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border); position: fixed; top: 0; left: -260px; bottom: 0; z-index: 1200; display: flex; flex-direction: column; transition: left .3s ease; }
    .sidebar.open { left: 0; }
    .content-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 80px; }
    main { padding: 1rem; flex: 1; }
    .page-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; }
    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1100; opacity: 0; pointer-events: none; transition: opacity .3s; }
    .backdrop.active { opacity: 1; pointer-events: auto; }
    .app-header { background: var(--header-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: space-between; }
    .header-icon-btn { width: 40px; height: 40px; display: grid; place-items: center; border-radius: 99px; background: transparent; color: var(--muted); font-size: 1rem; cursor: pointer; border: none; transition: all .2s; }
    .header-icon-btn:hover { background: var(--border); color: var(--text); }
    .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--border); }
    .sidebar-logo { display: flex; align-items: center; gap: .75rem; text-decoration: none; color: var(--text); }
    .sidebar-logo img { width: 40px; height: 40px; border-radius: 99px; }
    .sidebar-logo-text h2 { font-size: 1.2rem; font-weight: 600; line-height: 1.2; }
    .sidebar-logo-text p { font-size: .8rem; color: var(--muted); line-height: 1.2; }
    .sidebar-menu { flex: 1; padding: 1rem; overflow-y: auto; }
    .menu-heading { font-size: .75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; padding: 0 .75rem; margin: 1.5rem 0 .5rem; }
    .menu-item { display: flex; align-items: center; gap: .75rem; padding: .65rem .75rem; border-radius: 8px; font-weight: 500; text-decoration: none; color: var(--text); transition: background .2s, color .2s; cursor: pointer; }
    .menu-item i { width: 20px; text-align: center; color: var(--muted); transition: color .2s; }
    .menu-item:hover { background: var(--border); }
    .menu-item.active { background: var(--accent); color: white; font-weight: 600; }
    .menu-item.active i { color: white; }
    .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border); }
    #admin-panel { display: none; }
    .admin-logged-in #admin-panel { display: block; }
    .fab { position: fixed; bottom: 80px; right: 1rem; width: 56px; height: 56px; background: linear-gradient(45deg, var(--accent), var(--accent-dark)); color: white; border-radius: 50%; display: none; place-items: center; font-size: 1.5rem; box-shadow: var(--shadow-lg); z-index: 900; transition: transform .2s; border: none; cursor: pointer; }
    .admin-logged-in .fab { display: grid; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background: var(--header-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); flex: 1; padding: 0.5rem 0; transition: color 0.2s; cursor: pointer; }
    .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
    .nav-item .nav-text { font-size: 0.7rem; font-weight: 500; }
    .nav-item.active { color: var(--accent); }
    #post-grid { display: grid; gap: 1rem; }
    .post-card { background: var(--card); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); transition: transform .2s, box-shadow .2s; }
    .post-card-clickable { cursor: pointer; }
    .post-card-clickable:active { transform: scale(0.98); }
    .post-card-img-wrapper { position: relative; }
    .post-card-img { width: 100%; height: 200px; object-fit: cover; }
    .post-card-content { padding: 1rem; }
    .post-card-category { background: var(--accent); color: white; padding: 4px 10px; border-radius: 99px; font-weight: 600; font-size: 11px; display: inline-block; margin-bottom: 0.5rem; }
    .post-card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
    .post-card-desc { color: var(--muted); font-size: 0.9rem; line-height: 1.4; }
    .post-admin-controls { position: absolute; top: .75rem; right: .75rem; display: none; gap: .5rem; }
    .admin-logged-in .post-admin-controls { display: flex; }
    .admin-btn { width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; color: white; border: none; cursor: pointer; box-shadow: var(--shadow); }
    .admin-btn.edit { background: var(--warning); }
    .admin-btn.delete { background: var(--danger); }
    #banner-section { margin-bottom: 1.5rem; }
    .banner-card { position: relative; border-radius: 16px; overflow: hidden; min-height: 200px; background-color: var(--card); box-shadow: var(--shadow); display: flex; align-items: flex-end; }
    .banner-card img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
    .banner-card-overlay { position: relative; z-index: 2; width: 100%; padding: 1.5rem; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }
    .banner-card-title { font-size: 1.5rem; font-weight: 700; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
    .banner-card-desc { color: rgba(255,255,255,0.9); }
    .skeleton-card { background: var(--card); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); }
    .skeleton-img { height: 200px; background: var(--border); }
    .skeleton-content { padding: 1rem; }
    .skeleton-line { height: 1em; border-radius: 4px; background: var(--border); margin-bottom: .5rem; }
    .shimmer { position: relative; overflow: hidden; }
    .shimmer::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); animation: shimmer 1.5s infinite; }
    [data-theme="dark"] .shimmer::after { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); }
    @keyframes shimmer { 100% { left: 150%; } }
    .modal-backdrop { position: fixed; inset: 0; z-index: 1200; background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: opacity .3s; }
    .modal-container { position: fixed; inset: 0; z-index: 1300; display: flex; opacity: 0; pointer-events: none; transform: scale(0.95); transition: all .3s; }
    .modal-backdrop.open, .modal-container.open { opacity: 1; pointer-events: auto; transform: scale(1); }
    .modal-content { background: var(--card); display: flex; flex-direction: column; width: 100%; height: 100%; }
    .modal-header { display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border); flex-shrink: 0;}
    .modal-title { font-size: 1.1rem; font-weight: 600; flex: 1; text-align: center; }
    .modal-header .btn, .modal-header .header-icon-btn { margin-left: auto; }
    .modal-body { flex: 1; overflow-y: auto; }
    #post-modal-img { width: 100%; max-height: 40vh; object-fit: cover; }
    .post-details { padding: 1.5rem; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: none; border-radius: 8px; padding: 0.65rem 1.25rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--accent-dark); }
    .btn-ghost { background: var(--border); color: var(--text); }
    .btn-ghost:hover { background: #d1d5db; }
    [data-theme="dark"] .btn-ghost:hover { background: #4b5563; }
    .btn-block { width: 100%; }
    .input { background: var(--bg); border: 1px solid var(--border); padding: 0.75rem 1rem; border-radius: 8px; width: 100%; color: var(--text); }
    .input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--ring); }
    #auth-modal .modal-content, #post-form-modal .modal-content, #banner-form-modal .modal-content { max-width: 450px; width: 90vw; height: auto; margin: auto; border-radius: 16px; }
    .auth-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
    .auth-tab { flex: 1; text-align: center; padding: .75rem; font-weight: 600; color: var(--muted); cursor: pointer; border-bottom: 2px solid transparent; }
    .auth-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-weight: 500; font-size: 0.875rem; margin-bottom: 0.5rem; }
    .auth-error { color: var(--danger); font-size: .875rem; text-align: center; margin-top: 1rem; }
    #empty-state { text-align: center; padding: 3rem 1rem; color: var(--muted); border: 2px dashed var(--border); border-radius: 16px; }
    @media (min-width: 768px) {
      body { overflow: hidden; }
      .app-layout { margin-left: 260px; }
      .sidebar { left: 0; }
      .content-wrapper { padding-bottom: 0; }
      main { padding: 1.5rem 2rem; }
      .bottom-nav, #menu-toggle, .backdrop, .fab { display: none; }
      #post-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
      #post-modal .modal-container { inset: auto; align-items: center; justify-content: center; }
      #post-modal .modal-content { width: 90vw; max-width: 900px; height: auto; max-height: 90vh; border-radius: 16px; box-shadow: var(--shadow-lg); }
      #post-modal .modal-body { display: grid; grid-template-columns: 3fr 2fr; }
      #post-modal #post-modal-img { max-height: none; height: 100%; }
      #post-modal .post-details { padding: 2rem; }
    }
    @media (hover: hover) { .post-card-clickable:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); } }
  </style>
</head>
<body>

  <div class="app-layout">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><a href="#" class="sidebar-logo"><img src="https://www.dropbox.com/scl/fi/yz8831kakxyc5f3t5f0dl/f8968f32c554ba5cd6bcab519fc0fae8.jpg?rlkey=398wt14ned3ugz3yx9en&st=9zczqkqw&dl=1" alt="logo"><div class="sidebar-logo-text"><h2>Luminox</h2><p>Platform Game</p></div></a></div>
        <nav class="sidebar-menu">
            <p class="menu-heading">Menu</p>
            <div class="menu-item active" data-category=""><i class="fas fa-home"></i> Semua Postingan</div>
            <p class="menu-heading">Kategori</p>
            <div class="menu-item" data-category="Addon"><i class="fas fa-puzzle-piece"></i> Addon</div>
            <div class="menu-item" data-category="Template"><i class="fas fa-paint-brush"></i> Template</div>
            <div class="menu-item" data-category="Event"><i class="fas fa-calendar-alt"></i> Event</div>
        </nav>
        <div class="sidebar-footer">
            <div id="admin-panel">
                <p class="menu-heading">Panel Admin</p>
                <div style="display: grid; gap: 0.5rem; padding: 0 0.5rem;">
                    <button class="btn btn-primary" id="add-post-btn-desktop"><i class="fas fa-plus"></i> Tambah Post</button>
                    <button class="btn btn-ghost" id="manage-banner-btn">Kelola Banner</button>
                    <button class="btn btn-ghost" id="logout-btn-desktop"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </div>
    </aside>

    <div class="content-wrapper">
      <header class="app-header">
        <button id="menu-toggle" class="header-icon-btn"><i class="fas fa-bars"></i></button>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <button id="search-toggle" class="header-icon-btn"><i class="fas fa-search"></i></button>
          <button id="theme-toggle" class="header-icon-btn"><i class="fas fa-moon"></i></button>
        </div>
      </header>
      <main>
        <section id="banner-section"></section>
        <h1 class="page-title">Postingan Terbaru</h1>
        <section id="post-grid"></section>
        <section id="skeleton-grid" class="hidden"></section>
        <section id="empty-state" class="hidden">
            <h2>Belum Ada Postingan</h2>
            <p>Jadilah yang pertama membuat postingan!</p>
        </section>
      </main>
    </div>
  </div>

  <div class="backdrop" id="backdrop"></div>
  <button class="fab" id="fab-add-post"><i class="fas fa-plus"></i></button>
  <nav class="bottom-nav">
    <div class="nav-item active" data-category=""><i class="fas fa-home"></i><span class="nav-text">Home</span></div>
    <div class="nav-item" data-category="Addon"><i class="fas fa-puzzle-piece"></i><span class="nav-text">Addon</span></div>
    <div class="nav-item" data-category="Template"><i class="fas fa-paint-brush"></i><span class="nav-text">Template</span></div>
    <div class="nav-item" id="auth-nav-item"><i class="fas fa-sign-in-alt"></i><span class="nav-text">Login</span></div>
  </nav>

  <div id="post-modal" class="hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
        <div class="modal-content">
            <header class="modal-header">
                <button class="header-icon-btn close-modal"><i class="fas fa-times"></i></button>
                <h2 class="modal-title">Detail Postingan</h2>
            </header>
            <div class="modal-body">
                <img id="post-modal-img" src="">
                <div class="post-details">
                    <h3 id="modal-title" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;"></h3>
                    <p id="modal-desc" style="color: var(--muted)"></p>
                </div>
            </div>
        </div>
    </div>
  </div>
  
  <div id="post-form-modal" class="hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
      <form id="post-form" class="modal-content">
        <header class="modal-header">
          <h2 class="modal-title" id="post-form-title">Tambah Postingan Baru</h2>
          <button type="submit" id="post-form-submit-btn" class="btn btn-primary">Simpan</button>
        </header>
        <div class="modal-body" style="padding: 1rem;">
            <input type="hidden" id="post-id-input">
            <div class="form-group"><label for="post-title-input" class="form-label">Judul</label><input type="text" id="post-title-input" class="input" required></div>
            <div class="form-group"><label for="post-desc-input" class="form-label">Deskripsi</label><textarea id="post-desc-input" class="input" rows="3"></textarea></div>
            <div class="form-group"><label for="post-category-input" class="form-label">Kategori</label><select id="post-category-input" class="input"><option value="Addon">Addon</option><option value="Template">Template</option><option value="Event">Event</option><option value="Lainnya">Lainnya</option></select></div>
            <div class="form-group"><label for="post-image-input" class="form-label">URL Gambar</label><input type="url" id="post-image-input" class="input" placeholder="https://..." required></div>
            <div class="form-group"><label for="post-link-input" class="form-label">URL Link Postingan (opsional)</label><input type="url" id="post-link-input" class="input" placeholder="https://..."></div>
        </div>
      </form>
    </div>
  </div>

  <div id="banner-form-modal" class="hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
      <form id="banner-form" class="modal-content">
        <header class="modal-header">
          <h2 class="modal-title">Kelola Banner</h2>
          <button type="submit" id="banner-form-submit-btn" class="btn btn-primary">Simpan</button>
        </header>
        <div class="modal-body" style="padding: 1rem;">
            <div class="form-group"><label for="banner-title-input" class="form-label">Judul Banner</label><input type="text" id="banner-title-input" class="input" required></div>
            <div class="form-group"><label for="banner-desc-input" class="form-label">Deskripsi Banner</label><input id="banner-desc-input" class="input"></div>
            <div class="form-group"><label for="banner-image-input" class="form-label">URL Gambar Banner</label><input type="url" id="banner-image-input" class="input" placeholder="https://..." required></div>
            <div class="form-group"><label for="banner-link-input" class="form-label">URL Link Banner (opsional)</label><input type="url" id="banner-link-input" class="input" placeholder="https://..."></div>
        </div>
      </form>
    </div>
  </div>

  <div id="auth-modal" class="hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
        <div class="modal-content">
            <header class="modal-header">
                <button class="header-icon-btn close-modal"><i class="fas fa-times"></i></button>
                <h2 class="modal-title" id="auth-modal-title">Login</h2>
            </header>
            <div class="modal-body" style="padding: 1rem;">
                <div class="auth-tabs">
                    <div id="tab-login" class="auth-tab active">Login</div>
                    <div id="tab-register" class="auth-tab">Register</div>
                </div>
                <form id="login-form">
                    <div class="form-group"><input type="email" id="login-email" class="input" placeholder="Email" required></div>
                    <div class="form-group"><input type="password" id="login-password" class="input" placeholder="Password" required></div>
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                </form>
                <form id="register-form" class="hidden">
                    <div class="form-group"><input type="email" id="register-email" class="input" placeholder="Email" required></div>
                    <div class="form-group"><input type="password" id="register-password" class="input" placeholder="Password" required></div>
                    <button type="submit" class="btn btn-primary btn-block">Register</button>
                </form>
                <p id="auth-error" class="auth-error hidden"></p>
            </div>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://zmhshfqpyekrcddsqhuz.supabase.co'; // Ganti dengan URL Anda
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptaHNoZnFweWVrcmNkZHNxaHV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzgxNDAsImV4cCI6MjA3NTcxNDE0MH0.I_AMK5MYj4Ett8fFnAEq-w8HHSqL9NYKnfuaTZOy4O8'; // Ganti dengan Kunci Anon Anda
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let state = {
            posts: [],
            banner: null,
            currentCategory: '',
            currentUser: null,
            isLoading: true,
            editingPostId: null,
        };

        // --- LOGIC BANNER ---
        const fetchBanner = async () => {
            const { data, error } = await supabase.from('banner').select('*').single();
            if (data) state.banner = data;
            renderBanner();
        };

        const handleBannerSubmit = async (event) => {
            event.preventDefault();
            const submitBtn = $('#banner-form-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Menyimpan...';

            const bannerData = {
                title: $('#banner-title-input').value,
                description: $('#banner-desc-input').value,
                image_url: $('#banner-image-input').value,
                link_url: $('#banner-link-input').value,
                updated_at: new Date()
            };

            const { error } = await supabase.from('banner').update(bannerData).eq('id', 1);
            if (error) {
                alert('Error: ' + error.message);
            } else {
                closeModal('#banner-form-modal');
                fetchBanner();
            }

            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Simpan';
        };
        
        // --- LOGIC POSTINGAN (CRUD) ---
        const fetchPosts = async () => {
            showLoading(true);
            const { data, error } = await supabase.from('posts').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error("Error fetching posts:", error);
                state.posts = [];
            } else {
                state.posts = data;
            }
            showLoading(false);
        };

        const handlePostSubmit = async (event) => {
            event.preventDefault();
            const submitBtn = $('#post-form-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Menyimpan...';

            const postData = {
                title: $('#post-title-input').value,
                description: $('#post-desc-input').value,
                category: $('#post-category-input').value,
                image_url: $('#post-image-input').value,
                link_url: $('#post-link-input').value,
                user_id: state.currentUser.id,
            };

            let error;
            if (state.editingPostId) {
                const { error: updateError } = await supabase.from('posts').update(postData).eq('id', state.editingPostId);
                error = updateError;
            } else {
                const { error: insertError } = await supabase.from('posts').insert([postData]);
                error = insertError;
            }

            if (error) {
                alert('Error: ' + error.message);
            } else {
                closeModal('#post-form-modal');
                fetchPosts(); // Refresh data
            }

            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Simpan';
        };
        
        const handleDeletePost = async (postId) => {
            if (confirm('Apakah Anda yakin ingin menghapus postingan ini?')) {
                const { error } = await supabase.from('posts').delete().eq('id', postId);
                if (error) {
                    alert('Gagal menghapus: ' + error.message);
                } else {
                    fetchPosts(); // Refresh data
                }
            }
        };

        // --- AUTHENTICATION LOGIC ---
        const handleRegister = async (email, password) => {
            const { user, error } = await supabase.auth.signUp({ email, password });
            if (error) {
                showAuthError(error.message);
            } else if (user) {
                const { error: insertError } = await supabase.from('users').insert({ id: user.id, email: user.email, role: 'member' });
                if (insertError) showAuthError("Gagal menyimpan data pengguna: " + insertError.message);
                else closeAuthModal();
            }
        };
        const handleLogin = async (email, password) => {
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) showAuthError(error.message);
            else closeAuthModal();
        };
        const handleLogout = async () => {
            if (confirm('Apakah Anda yakin ingin logout?')) await supabase.auth.signOut();
        };

        supabase.auth.onAuthStateChanged(async (_event, session) => {
            const user = session?.user;
            if (user) {
                const { data } = await supabase.from('users').select('role').eq('id', user.id).single();
                state.currentUser = { ...user, role: data?.role || 'member' };
            } else {
                state.currentUser = null;
            }
            updateUI();
        });

        // --- UI & RENDER FUNCTIONS ---
        const updateUI = () => {
            const isAdmin = state.currentUser?.role === 'admin';
            document.body.classList.toggle('admin-logged-in', isAdmin);
            const authNavItem = $('#auth-nav-item');
            if (state.currentUser) {
                const icon = isAdmin ? 'fa-user-shield' : 'fa-user-circle';
                const text = isAdmin ? 'Admin' : 'Akun';
                authNavItem.innerHTML = `<i class="fas ${icon}"></i><span class="nav-text">${text}</span>`;
                authNavItem.onclick = handleLogout;
            } else {
                authNavItem.innerHTML = `<i class="fas fa-sign-in-alt"></i><span class="nav-text">Login</span>`;
                authNavItem.onclick = openAuthModal;
            }
            fetchBanner();
            fetchPosts();
        };
        
        const renderBanner = () => {
            const bannerSection = $('#banner-section');
            if (state.banner && state.banner.image_url) {
                bannerSection.innerHTML = `
                <div class="banner-card" ${state.banner.link_url ? `onclick="window.open('${state.banner.link_url}', '_blank')"` : ''} style="cursor: ${state.banner.link_url ? 'pointer': 'default'}">
                    <img src="${state.banner.image_url}" alt="${state.banner.title}">
                    <div class="banner-card-overlay">
                        <h2 class="banner-card-title">${state.banner.title}</h2>
                        <p class="banner-card-desc">${state.banner.description || ''}</p>
                    </div>
                </div>`;
            } else {
                bannerSection.innerHTML = '';
            }
        };

        const createPostElement = (post) => {
            const el = document.createElement('div');
            el.className = 'post-card';
            el.innerHTML = `
                <div class="post-card-img-wrapper post-card-clickable">
                    <img src="${post.image_url}" alt="${post.title}" class="post-card-img">
                    <div class="post-admin-controls">
                        <button class="admin-btn edit"><i class="fas fa-pen"></i></button>
                        <button class="admin-btn delete"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="post-card-content post-card-clickable">
                    <div class="post-card-category">${post.category || 'Lainnya'}</div>
                    <h3 class="post-card-title">${post.title}</h3>
                    <p class="post-card-desc">${post.description || ''}</p>
                </div>`;

            el.querySelector('.post-card-clickable').addEventListener('click', () => openPostModal(post));
            
            const editBtn = el.querySelector('.edit');
            if(editBtn) editBtn.addEventListener('click', (e) => { e.stopPropagation(); openPostFormModal(post); });
            
            const deleteBtn = el.querySelector('.delete');
            if(deleteBtn) deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); handleDeletePost(post.id); });

            return el;
        };
        
        const renderPosts = () => {
            const grid = $('#post-grid');
            grid.innerHTML = '';
            const filteredPosts = state.posts.filter(p => !state.currentCategory || p.category === state.currentCategory);
            
            if (filteredPosts.length === 0 && !state.isLoading) {
                $('#empty-state').classList.remove('hidden');
            } else {
                $('#empty-state').classList.add('hidden');
                filteredPosts.forEach(post => grid.appendChild(createPostElement(post)));
            }
        };

        const showLoading = (loading) => {
            state.isLoading = loading;
            $('#skeleton-grid').classList.toggle('hidden', !loading);
            $('#post-grid').classList.toggle('hidden', loading);
            if (!loading) {
                renderPosts();
            }
        };
        
        // --- MODAL & FORM LOGIC ---
        const openModal = (modalId) => $(modalId).classList.remove('hidden');
        const closeModal = (modalId) => $(modalId).classList.add('hidden');
        const openAuthModal = () => openModal('#auth-modal');
        const closeAuthModal = () => { closeModal('#auth-modal'); $('#auth-error').classList.add('hidden'); };
        const showAuthError = (message) => {
            $('#auth-error').textContent = message;
            $('#auth-error').classList.remove('hidden');
        }
        const openPostModal = (post) => {
            if (!post) return;
            $('#post-modal-img').src = post.image_url;
            $('#modal-title').textContent = post.title;
            $('#modal-desc').textContent = post.description;
            openModal('#post-modal');
        };
        const openPostFormModal = (post = null) => {
            $('#post-form').reset();
            if (post) { // Edit mode
                state.editingPostId = post.id;
                $('#post-form-title').textContent = 'Edit Postingan';
                $('#post-id-input').value = post.id;
                $('#post-title-input').value = post.title;
                $('#post-desc-input').value = post.description;
                $('#post-category-input').value = post.category;
                $('#post-image-input').value = post.image_url;
                $('#post-link-input').value = post.link_url;
            } else { // Create mode
                state.editingPostId = null;
                $('#post-form-title').textContent = 'Tambah Postingan Baru';
            }
            openModal('#post-form-modal');
        };

        const openBannerFormModal = () => {
            if (!state.banner) { alert("Data banner belum termuat, coba lagi."); return; }
            $('#banner-form').reset();
            $('#banner-title-input').value = state.banner.title;
            $('#banner-desc-input').value = state.banner.description;
            $('#banner-image-input').value = state.banner.image_url;
            $('#banner-link-input').value = state.banner.link_url;
            openModal('#banner-form-modal');
        };

        // --- EVENT LISTENERS ---
        const closeModalHandler = () => {
            closeModal('#post-modal');
            closeModal('#auth-modal');
            closeModal('#post-form-modal');
            closeModal('#banner-form-modal');
        }
        $$('.close-modal').forEach(btn => btn.addEventListener('click', closeModalHandler));
        $$('.modal-backdrop').forEach(backdrop => backdrop.addEventListener('click', closeModalHandler));

        $('#fab-add-post').addEventListener('click', () => openPostFormModal());
        $('#add-post-btn-desktop').addEventListener('click', () => openPostFormModal());
        $('#manage-banner-btn').addEventListener('click', openBannerFormModal);
        $('#post-form').addEventListener('submit', handlePostSubmit);
        $('#banner-form').addEventListener('submit', handleBannerSubmit);
        
        $('#tab-login').onclick = () => {$('#tab-login').classList.add('active');$('#tab-register').classList.remove('active');$('#login-form').classList.remove('hidden');$('#register-form').classList.add('hidden');$('#auth-modal-title').textContent = 'Login';$('#auth-error').classList.add('hidden');};
        $('#tab-register').onclick = () => {$('#tab-login').classList.remove('active');$('#tab-register').classList.add('active');$('#login-form').classList.add('hidden');$('#register-form').classList.remove('hidden');$('#auth-modal-title').textContent = 'Register';$('#auth-error').classList.add('hidden');};
        $('#login-form').addEventListener('submit', (e) => {e.preventDefault();handleLogin($('#login-email').value, $('#login-password').value);});
        $('#register-form').addEventListener('submit', (e) => {e.preventDefault();handleRegister($('#register-email').value, $('#register-password').value);});
        $('#theme-toggle').onclick = () => {const newTheme = document.body.dataset.theme === 'dark' ? '' : 'dark';document.body.dataset.theme = newTheme;$('#theme-toggle i').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';localStorage.setItem('luminox_theme', newTheme);};
        $('#menu-toggle').onclick = () => { $('#sidebar').classList.add('open'); $('#backdrop').classList.add('active'); };
        $('#backdrop').onclick = () => { $('#sidebar').classList.remove('open'); $('#backdrop').classList.remove('active'); };
        $$('[data-category]').forEach(item => {item.onclick = (e) => {e.preventDefault();$$('[data-category]').forEach(i => i.classList.remove('active'));$$(`[data-category="${item.dataset.category}"]`).forEach(i => i.classList.add('active'));state.currentCategory = item.dataset.category;renderPosts();if(window.innerWidth < 768) {$('#sidebar').classList.remove('open');$('#backdrop').classList.remove('active');}}});
        $('#logout-btn-desktop').onclick = handleLogout;
        
        const init = () => {
            document.body.dataset.theme = localStorage.getItem('luminox_theme') || '';
            $('#theme-toggle i').className = document.body.dataset.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            const skeletonGrid = $('#skeleton-grid');
            const skeletonCardHTML = `<div class="skeleton-card"><div class="skeleton-img shimmer"></div><div class="skeleton-content"><div class="skeleton-line shimmer" style="width: 25%"></div><div class="skeleton-line shimmer" style="width: 75%"></div><div class="skeleton-line shimmer" style="width: 50%"></div></div></div>`;
            skeletonGrid.innerHTML = Array(4).fill(skeletonCardHTML).join('');
        };

        init();
    });
  </script>
</body>
</html>
