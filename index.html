<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luminox â€” DLC Game</title>
  
  <link rel="icon" href="https://www.dropbox.com/scl/fi/yz8831kakxyc5f3t5f0dl/f8968f32c554ba5cd6bcab519fc0fae8.jpg?rlkey=398wt14ned3ugz41gjz3yx9en&st=6cfbpj8t&dl=1">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #f8f9fa; --card: #ffffff; --sidebar-bg: #ffffff; --text: #212529; --muted: #6c757d; --accent: #007bff; --accent-dark: #0056b3; --danger: #e74c3c; --success: #28a745; --ring: rgba(0, 123, 255, 0.25); --header-bg: rgba(255, 255, 255, 0.85); --border: #dee2e6; --shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.07); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
    }
    [data-theme="dark"] {
      --bg: #121212; --card: #1e1e1e; --sidebar-bg: #1e1e1e; --text: #e0e0e0; --muted: #9e9e9e; --accent: #64b5f6; --accent-dark: #2196f3; --danger: #e57373; --success: #81c784; --header-bg: rgba(30, 30, 30, 0.85); --border: #424242; --ring: rgba(100, 181, 246, 0.3);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
    body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; transition: background .3s, color .3s; }
    .hidden { display: none !important; }
    .app-layout { display: flex; transition: margin-left .3s ease; }
    .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border); position: fixed; top: 0; left: -260px; bottom: 0; z-index: 1200; display: flex; flex-direction: column; transition: left .3s ease; box-shadow: var(--shadow); }
    .sidebar.open { left: 0; }
    .content-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 80px; }
    main, #chat-view { padding: 1rem; flex: 1; }
    .page-title { font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem; letter-spacing: -0.5px; }
    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1100; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    .backdrop.active { opacity: 1; pointer-events: auto; }
    .app-header { background: var(--header-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .header-left, .header-right { display: flex; align-items: center; gap: .5rem; transition: opacity 0.3s ease; }
    .header-search-container { flex: 1; display: flex; justify-content: flex-end; }
    #header-search-input { width: 0; padding: 0; border: none; background: transparent; outline: none; font-size: 1rem; color: var(--text); transition: all 0.4s ease-in-out; }
    .app-header.search-active #header-search-input { width: 100%; padding: 0.5rem; border-bottom: 2px solid var(--accent); }
    .app-header.search-active .header-left, .app-header.search-active .header-right .header-icon-btn:not(#search-toggle) { opacity: 0; pointer-events: none; }
    #search-toggle .fa-times { display: none; }
    .app-header.search-active #search-toggle .fa-search { display: none; }
    .app-header.search-active #search-toggle .fa-times { display: block; }
    .header-icon-btn { width: 40px; height: 40px; display: grid; place-items: center; border-radius: 50%; background: transparent; color: var(--muted); font-size: 1.1rem; cursor: pointer; border: none; transition: all .2s; }
    .header-icon-btn:hover { background: var(--border); color: var(--text); }
    
    #notifications-toggle.subscribed { color: var(--success); }
    
    .sidebar-header { padding: 1.5rem 1rem; border-bottom: 1px solid var(--border); }
    .sidebar-logo { display: flex; align-items: center; gap: .75rem; text-decoration: none; color: var(--text); }
    .sidebar-logo img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; box-shadow: var(--shadow); }
    .sidebar-logo-text h2 { font-size: 1.25rem; font-weight: 600; line-height: 1.2; margin: 0; }
    .sidebar-logo-text p { font-size: .85rem; color: var(--muted); line-height: 1.2; margin: 0; }
    .sidebar-menu { flex: 1; padding: 1rem; overflow-y: auto; }
    .menu-heading { font-size: .7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .8px; padding: 0 .75rem; margin: 1.5rem 0 .75rem; }
    .menu-item { display: flex; align-items: center; gap: .85rem; padding: .75rem; border-radius: 8px; font-weight: 500; text-decoration: none; color: var(--text); transition: background .2s, color .2s; cursor: pointer; }
    .menu-item i { width: 20px; text-align: center; color: var(--muted); transition: color .2s; font-size: 0.95rem; }
    .menu-item:hover { background: var(--border); }
    .menu-item.active { background: var(--accent); color: white; font-weight: 600; }
    .menu-item.active i { color: white; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background: var(--header-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); flex: 1; padding: 0.5rem 0; cursor: pointer; transition: color 0.2s ease, transform 0.1s ease; }
    .nav-item:active { transform: scale(0.92); }
    .nav-item i { font-size: 1.3rem; margin-bottom: 2px; }
    .nav-item .nav-text { font-size: 0.75rem; font-weight: 500; }
    .nav-item.active { color: var(--accent); }
    #post-grid { display: grid; gap: 1rem; }
    .post-card { background: var(--card); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); transition: transform .25s ease, box-shadow .25s ease; cursor: pointer; position: relative; }
    .post-card-img-wrapper { position: relative; }
    .post-card-img { width: 100%; height: 200px; object-fit: cover; display: block; }
    .post-card-content { padding: 1.25rem; }
    .post-card-category { background: var(--accent); color: white; padding: 5px 12px; border-radius: 99px; font-weight: 600; font-size: 11px; display: inline-block; margin-bottom: 0.75rem; }
    .post-card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.25rem; }
    .post-card-desc { color: var(--muted); font-size: 0.95rem; line-height: 1.5; }
    .wishlist-btn { position: absolute; top: 0.75rem; right: 0.75rem; width: 40px; height: 40px; border-radius: 50%; background-color: rgba(0,0,0,0.4); color: white; border: none; cursor: pointer; display: grid; place-items: center; font-size: 1.1rem; transition: transform 0.2s ease, color 0.2s ease; }
    .wishlist-btn:hover { transform: scale(1.1); }
    .wishlist-btn.wishlisted { color: var(--danger); }
    .wishlist-btn .fa-solid { display: none; }
    .wishlist-btn.wishlisted .fa-regular { display: none; }
    .wishlist-btn.wishlisted .fa-solid { display: inline-block; animation: heartbeat 0.5s ease; }
    @keyframes heartbeat { 0% {transform: scale(1);} 50% {transform: scale(1.3);} 100% {transform: scale(1);} }
    .edit-btn { position: absolute; top: 0.75rem; left: 0.75rem; width: 40px; height: 40px; border-radius: 50%; background-color: rgba(0,0,0,0.4); color: white; border: none; cursor: pointer; display: grid; place-items: center; font-size: 1rem; transition: transform 0.2s ease, background-color 0.2s ease; z-index: 5; }
    .edit-btn:hover { transform: scale(1.1); background-color: rgba(0, 123, 255, 0.8); }
    .skeleton-card { background: var(--card); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); }
    .skeleton-img { height: 200px; background: var(--border); }
    .skeleton-content { padding: 1.25rem; }
    .skeleton-line { height: 1em; border-radius: 4px; background: var(--border); margin-bottom: .75rem; }
    .shimmer { position: relative; overflow: hidden; }
    .shimmer::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); animation: shimmer 1.5s infinite; }
    [data-theme="dark"] .shimmer::after { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); }
    @keyframes shimmer { 100% { left: 150%; } }
    #post-modal-wrapper, #auth-modal-wrapper, #request-modal-wrapper { position: fixed; inset: 0; z-index: 1300; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    #post-modal-wrapper.open, #auth-modal-wrapper.open, #request-modal-wrapper.open { opacity: 1; pointer-events: auto; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .modal-container { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .modal-content { background: var(--card); width: 100%; max-width: 520px; border-radius: 16px; box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform .3s ease; display: flex; flex-direction: column; max-height: 90vh; }
    #post-modal-wrapper.open .modal-content, #auth-modal-wrapper.open .modal-content, #request-modal-wrapper.open .modal-content { transform: scale(1); }
    #post-modal-header { position: relative; }
    #post-modal-img { width: 100%; height: 220px; object-fit: cover; display: block; }
    #post-modal-close { position: absolute; top: 0.75rem; right: 0.75rem; background: rgba(0,0,0,0.4); color: white; z-index: 10; }
    #post-modal-close:hover { background: rgba(0,0,0,0.6); }
    .post-details { padding: 1.5rem; }
    #modal-category { background: var(--accent); color: white; padding: 5px 12px; border-radius: 99px; font-weight: 600; font-size: 11px; display: inline-block; margin-bottom: 0.75rem; }
    #modal-title { font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem; }
    #modal-desc { color: var(--muted); font-size: 0.95rem; line-height: 1.6; margin: 0 0 1.5rem; }
    .download-section h4 { margin: 0 0 1rem; font-size: 0.9rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
    .download-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .btn-download { display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 0.75rem; border-radius: 8px; font-weight: 600; transition: all .2s ease; }
    .btn-download i { margin-right: 0.5rem; font-size: 1.1rem; }
    .btn-mediafire { background-color: #0099e5; color: white; }
    .btn-mediafire:hover { background-color: #0077b2; transform: translateY(-2px); }
    .btn-gofile { background-color: #215ff3; color: white; }
    .btn-gofile:hover { background-color: #1a4ccc; transform: translateY(-2px); }
    #auth-container input, #auth-container textarea, #auth-container select, #request-container input, #request-container textarea, #request-container select { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 1rem; }
    #auth-container button, #request-container button { width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background: var(--accent); color: white; font-weight: 600; cursor: pointer; transition: background .2s; }
    #auth-container button:hover, #request-container button:hover { background: var(--accent-dark); }
    #auth-container #logout-btn { background-color: var(--danger); }
    #auth-container .admin-nav-link { display: block; text-align: center; margin-bottom: 1.5rem; color: var(--accent); font-weight: 500; cursor: pointer; }
    #auth-container .admin-nav-link:hover { text-decoration: underline; }
    #auth-container p a { color: var(--accent); text-decoration: none; font-weight: 500; }
    #auth-container p a:hover { text-decoration: underline; }
    .profile-header { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
    .profile-avatar-wrapper { position: relative; }
    .profile-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border); }
    #avatar-upload-label { position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; background: var(--accent); color: white; border-radius: 50%; display: grid; place-items: center; cursor: pointer; border: 2px solid var(--card); }
    #avatar-upload-label:hover { background: var(--accent-dark); }
    
    #auth-container {
        overflow-y: auto;
        flex: 1;
        padding: 1.5rem;
    }
    #user-list-container {
        padding-right: 5px;
    }
    
    .user-management-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
    .user-management-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background-color: var(--bg); border-radius: 8px; border: 1px solid var(--border); }
    .user-management-info { display: flex; flex-direction: column; }
    .user-management-info .nickname { font-weight: 600; }
    .user-management-info .email { font-size: 0.85rem; color: var(--muted); }
    .user-management-role select { padding: 0.3rem 0.5rem; border-radius: 6px; border: 1px solid var(--border); background-color: var(--card); color: var(--text); }
    #notification-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
    .toast { background: var(--card); color: var(--text); padding: 12px 20px; border-radius: 8px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; border-left: 5px solid; transition: transform 0.3s ease, opacity 0.3s ease; transform: translateX(calc(100% + 20px)); }
    .toast.show { transform: translateX(0); }
    .toast.hide { transform: translateX(calc(100% + 20px)); opacity: 0; }
    .toast i { font-size: 1.2rem; }
    .toast.success { border-color: var(--success); }
    .toast.success i { color: var(--success); }
    .toast.error { border-color: var(--danger); }
    .toast.error i { color: var(--danger); }
    .comment-section { padding: 0 1.5rem 1.5rem; border-top: 1px solid var(--border); flex: 1; overflow-y: auto; }
    .comment-section h4 { margin: 1.5rem 0 1rem; font-size: 0.9rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
    #comment-list { display: flex; flex-direction: column; gap: 1rem; }
    .comment-item { display: flex; gap: .75rem; }
    .comment-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-top: 2px; flex-shrink: 0; }
    .comment-content { flex: 1; }
    .comment-header { display: flex; align-items: center; gap: .5rem; margin-bottom: 2px; }
    .comment-author { font-weight: 600; font-size: .9rem; }
    .comment-date { font-size: .75rem; color: var(--muted); margin-left: auto; }
    .comment-body { font-size: .95rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    #comment-form { display: flex; gap: .75rem; align-items: flex-start; margin-bottom: 1.5rem; }
    #comment-form textarea { flex: 1; resize: vertical; min-height: 40px; padding: 0.5rem 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: .95rem; }
    #comment-form button { padding: 0.5rem 1rem; border-radius: 8px; border: none; background: var(--accent); color: white; font-weight: 600; cursor: pointer; transition: background .2s; }
    #comment-form button:hover { background: var(--accent-dark); }
    #comment-login-prompt, .chat-login-prompt { text-align: center; padding: 2rem 1rem; }
    #comment-login-prompt i, .chat-login-prompt i { font-size: 2.5rem; color: var(--muted); margin-bottom: 1rem; }
    #comment-login-prompt h3, .chat-login-prompt h3 { margin-top: 0; }
    #comment-login-prompt p, .chat-login-prompt p { color: var(--muted); }
    #comment-login-prompt a { color: var(--accent); font-weight: 600; cursor: pointer; text-decoration: none; }
    #comment-login-prompt a:hover { text-decoration: underline; }
    .role-badge { font-size: .65rem; font-weight: 700; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; line-height: 1; vertical-align: middle; }
    .role-badge.admin { background-color: var(--danger); color: white; }
    .role-badge.moderator { background-color: var(--accent); color: white; }
    .role-badge.user { background-color: var(--border); color: var(--text); }
    .request-management-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
    .request-management-item { display: flex; flex-direction: column; padding: 1rem; background-color: var(--bg); border-radius: 8px; border: 1px solid var(--border); }
    .request-management-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .request-management-title { font-weight: 600; margin: 0; }
    .request-management-category { font-size: 0.8rem; background-color: var(--accent); color: white; padding: 3px 8px; border-radius: 5px; }
    .request-management-user { font-size: 0.85rem; color: var(--muted); margin: 0.25rem 0 0.75rem; }
    .request-management-desc { font-size: 0.9rem; margin-bottom: 1rem; }
    .request-management-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }
    .request-management-actions button { width: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem; }
    .request-management-actions .delete-btn { background-color: var(--danger); }

    /* --- Tampilan Chat & Menu Edit/Hapus --- */
    #chat-view { padding: 0; display: flex; justify-content: center; }
    #chat-view-container { display: flex; flex-direction: column; height: calc(100vh - 70px); max-width: 900px; width: 100%; background: var(--card); }
    .chat-messages { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; scroll-behavior: smooth; }
    .chat-message { display: flex; gap: 1rem; max-width: 75%; align-items: flex-end; user-select: none; -webkit-user-select: none; }
    .chat-message.current-user { align-self: flex-end; flex-direction: row-reverse; }
    .chat-message .message-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; box-shadow: var(--shadow); }
    .message-content { display: flex; flex-direction: column; width: 100%; }
    .message-bubble { position: relative; padding: 0.75rem 1.25rem; border-radius: 18px; background: var(--bg); box-shadow: var(--shadow); line-height: 1.5; }
    .chat-message.current-user .message-bubble { background: var(--accent); color: white; cursor: pointer; }
    .message-meta { display: flex; justify-content: space-between; align-items: center; padding: 0 .5rem; margin-bottom: 4px; }
    .chat-message.current-user .message-meta { flex-direction: row-reverse; }
    .message-author { font-weight: 600; font-size: .8rem; }
    .message-timestamp { font-size: .7rem; color: var(--muted); }
    .chat-message.current-user .message-author { color: var(--text); opacity: 0.9; }
    .message-text { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
    .message-edited-tag { font-size: 0.7rem; color: var(--muted); opacity: 0.8; margin-left: 5px; }
    .chat-message.current-user .message-edited-tag { color: white; }
    #chat-form { display: flex; gap: .75rem; padding: 1rem; border-top: 1px solid var(--border); background-color: var(--sidebar-bg); }
    #chat-form input { flex: 1; padding: 0.85rem 1.25rem; border-radius: 99px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 1rem; }
    #chat-form input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--ring); outline: none; }
    #chat-form button { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--accent); color: white; font-weight: 600; cursor: pointer; transition: all .2s; font-size: 1.1rem; flex-shrink: 0; }
    #chat-form button:hover { background: var(--accent-dark); transform: scale(1.05); }

    .message-context-menu { position: fixed; z-index: 1500; background: var(--card); border-radius: 8px; box-shadow: var(--shadow-lg); overflow: hidden; display: none; }
    .context-menu-btn { padding: 0.75rem 1.25rem; background: none; border: none; color: var(--text); display: flex; align-items: center; gap: 0.75rem; width: 100%; text-align: left; cursor: pointer; }
    .context-menu-btn:hover { background: var(--bg); }
    .context-menu-btn.delete { color: var(--danger); }
    
    .message-edit-form { display: flex; flex-direction: column; gap: 0.5rem; }
    .message-edit-form textarea { width: 100%; resize: vertical; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; }
    .message-edit-form .edit-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
    .message-edit-form button { background: var(--accent); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; }
    .message-edit-form .cancel-btn { background: var(--muted); }

    @media (min-width: 768px) {
      #chat-view-container { height: calc(100vh - 85px); border: 1px solid var(--border); border-radius: 16px; margin: 1rem 0; box-shadow: var(--shadow-lg); }
      .bottom-nav, #menu-toggle, .backdrop { display: none; }
      .app-layout { margin-left: 260px; }
      .sidebar { left: 0; box-shadow: none; }
      main { padding: 2rem; }
      #post-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
    }
    @media (hover: hover) { .post-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-lg); } }

    /* --- CSS POPUP --- */
    #welcome-popup-wrapper {
      position: fixed;
      inset: 0;
      z-index: 2100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    #welcome-popup-wrapper.open {
      opacity: 1;
      pointer-events: auto;
    }
    #welcome-popup-wrapper .popup-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
    }
    #welcome-popup-wrapper .popup-content {
      position: relative;
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 320px; 
      overflow: hidden;
      transform: scale(0.9);
      transition: transform .3s ease;
    }
    #welcome-popup-wrapper.open .popup-content {
      transform: scale(1);
    }
    #welcome-popup-wrapper .popup-content img {
      width: 100%;
      height: auto;
      display: block;
    }
    #welcome-popup-wrapper .popup-close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.4);
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 36px;
      text-align: center;
      cursor: pointer;
      display: grid;
      place-items: center;
      z-index: 10;
      transition: all .2s;
    }
    #welcome-popup-wrapper .popup-close-btn:hover {
      background: rgba(0,0,0,0.7);
      transform: scale(1.1);
    }
    /* --- AKHIR CSS POPUP --- */

  </style>
</head>
<body>

  <div class="app-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="#" class="sidebar-logo">
          <img src="https://www.dropbox.com/scl/fi/yz8831kakxyc5f3t5f0dl/f8968f32c554ba5cd6bcab519fc0fae8.jpg?rlkey=398wt14ned3ugz41gjz3yx9en&st=6cfbpj8t&dl=1" alt="logo">
          <div class="sidebar-logo-text"><h2>Luminox</h2><p>Galeri Minecraft</p></div>
        </a>
      </div>
      <nav class="sidebar-menu">
        <p class="menu-heading">Menu</p>
        <div class="menu-item active" data-category=""><i class="fas fa-home"></i> Semua Postingan</div>
        <div class="menu-item" data-category="featured"><i class="fas fa-star"></i> Pilihan Editor</div>
        <div class="menu-item" data-category="wishlist"><i class="fas fa-heart"></i> Wishlist</div>
        <div class="menu-item" data-category="history"><i class="fas fa-history"></i> Riwayat Unduhan</div>
        <p class="menu-heading">Kategori</p>
        <div class="menu-item" data-category="addon"><i class="fas fa-puzzle-piece"></i> Addon</div>
        <div class="menu-item" data-category="template"><i class="fas fa-paint-brush"></i> Template</div>
        <div class="menu-item" data-category="texturepack"><i class="fas fa-calendar-alt"></i> TexturePack</div>
        <div class="menu-item" data-category="informasi"><i class="fas fa-info-circle"></i> Informasi</div>
        <p class="menu-heading">Interaksi</p>
        <div class="menu-item" id="request-menu-btn"><i class="fas fa-bullhorn"></i> Request</div>
        <div class="menu-item" id="chat-menu-btn"><i class="fas fa-comments"></i> Chat</div>
        <a href="https://linktr.ee/LuminoxMC" target="_blank" rel="noopener noreferrer" class="menu-item"><i class="fas fa-link"></i> Linktree</a>
        <p class="menu-heading">Akun</p>
        <div class="menu-item" id="auth-menu-btn"><i class="fas fa-user-circle"></i><span id="auth-menu-text">Login</span></div>
      </nav>
    </aside>

    <div class="content-wrapper">
      <header class="app-header" id="app-header">
        <div class="header-left">
            <button id="menu-toggle" class="header-icon-btn"><i class="fas fa-bars"></i></button>
        </div>
        <div class="header-search-container">
            <input type="search" id="header-search-input" placeholder="Cari postingan..." autocomplete="off">
        </div>
        <div class="header-right">
            <button id="search-toggle" class="header-icon-btn">
                <i class="fas fa-search"></i>
                <i class="fas fa-times"></i>
            </button>
            <button id="notifications-toggle" class="header-icon-btn" title="Aktifkan Notifikasi">
                <i class="fas fa-bell"></i>
            </button>
            <button id="theme-toggle" class="header-icon-btn"><i class="fas fa-moon"></i></button>
        </div>
      </header>
      <main>
        <h1 class="page-title" id="page-title">Postingan Terbaru</h1>
        <section id="post-grid"></section>
        <section id="skeleton-grid" class="hidden"></section>
      </main>
      <section id="chat-view" class="hidden"></section>
    </div>
  </div>

  <div class="backdrop" id="backdrop"></div>

  <nav class="bottom-nav">
    <div class="nav-item active" data-category=""><i class="fas fa-home"></i><span class="nav-text">Home</span></div>
    <div class="nav-item" data-category="featured"><i class="fas fa-star"></i><span class="nav-text">Pilihan</span></div>
    <div class="nav-item" data-category="wishlist"><i class="fas fa-heart"></i><span class="nav-text">Wishlist</span></div>
    <div class="nav-item" id="auth-bottom-nav-btn"><i class="fas fa-user-circle"></i><span class="nav-text">Akun</span></div>
  </nav>
  
  <div id="message-context-menu" class="message-context-menu">
      <button id="edit-msg-btn" class="context-menu-btn"><i class="fas fa-pencil-alt"></i> Edit</button>
      <button id="delete-msg-btn" class="context-menu-btn delete"><i class="fas fa-trash"></i> Hapus</button>
  </div>

  <div id="post-modal-wrapper">
    <div class="modal-backdrop"></div>
    <div id="post-modal" class="modal-container">
        <div class="modal-content">
            <header id="post-modal-header">
                <img id="post-modal-img" src="" alt="Detail Gambar Postingan">
                <button id="post-modal-close" class="header-icon-btn close-modal"><i class="fas fa-times"></i></button>
            </header>
            <div class="post-details">
                <div id="modal-category"></div>
                <h3 id="modal-title"></h3>
                <p id="modal-desc"></p>
                <div class="download-section">
                    <h4>Unduh File</h4>
                    <div class="download-buttons">
                        <a href="#" id="mediafire-link" target="_blank" class="btn-download btn-mediafire"><i class="fa-solid fa-cloud-arrow-down"></i> MediaFire</a>
                        <a href="#" id="gofile-link" target="_blank" class="btn-download btn-gofile"><i class="fa-solid fa-rocket"></i> Gofile</a>
                    </div>
                </div>
            </div>
            <div class="comment-section">
                <h4>Komentar</h4>
                <div id="comment-form-container"></div>
                <div id="comment-list"></div>
            </div>
        </div>
    </div>
  </div>

  <div id="auth-modal-wrapper">
    <div class="modal-backdrop" id="auth-modal-backdrop"></div>
    <div class="modal-container">
      <div class="modal-content" style="max-width: 420px; position: relative;">
        <button id="auth-modal-close" class="header-icon-btn" style="position:absolute; top:0.5rem; right:0.5rem; z-index:10;"><i class="fas fa-times"></i></button>
        <div id="auth-container"></div>
      </div>
    </div>
  </div>

  <div id="request-modal-wrapper">
    <div class="modal-backdrop" id="request-modal-backdrop"></div>
    <div class="modal-container">
      <div class="modal-content" style="max-width: 480px; position: relative; max-height: none;">
        <button id="request-modal-close" class="header-icon-btn" style="position:absolute; top:0.5rem; right:0.5rem; z-index:10;"><i class="fas fa-times"></i></button>
        <div id="request-container" style="padding: 1.5rem 2rem;"></div>
      </div>
    </div>
  </div>

  <div id="notification-container"></div>

  <div id="welcome-popup-wrapper">
    <div class="popup-backdrop"></div>
    <div class="popup-content">
      <button class="popup-close-btn">&times;</button>
      <img src="https://res.cloudinary.com/do3yj5r1m/image/upload/v1761787740/ox8f0ei4w2uvpaelytcw.png" alt="Butuh Admin Telegram">
    </div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);

      const SUPABASE_URL = 'https://zmhshfqpyekrcddsqhuz.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptaHNoZnFweWVrcmNkZHNxaHV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzgxNDAsImV4cCI6MjA3NTcxNDE0MH0.I_AMK5MYj4Ett8fFnAEq-w8HHSqL9NYKnfuaTZOy4O8';
      
      const VAPID_PUBLIC_KEY = 'BJPmbgeeLhcQIeo2CSt5vjqVy0WQ1qNjclpwcUD2Qrq2Duz_7zCyxFz9-zzC-tR8qn188pRo4pSoxnb4F0qotgo';

      const { createClient } = window.supabase;
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const createStorageManager = (key) => ({ get: () => JSON.parse(localStorage.getItem(key)) || [], save: (data) => localStorage.setItem(key, JSON.stringify(data)), });
      const WishlistManager = { ...createStorageManager('luminox_wishlist'), add: (postId) => { const wishlist = WishlistManager.get(); if (!wishlist.includes(postId)) { wishlist.push(postId); WishlistManager.save(wishlist); } }, remove: (postId) => { let wishlist = WishlistManager.get(); wishlist = wishlist.filter(id => id !== postId); WishlistManager.save(wishlist); }, has: (postId) => WishlistManager.get().includes(postId) };
      const HistoryManager = { ...createStorageManager('luminox_history'), add: (postId) => { let history = HistoryManager.get(); history = history.filter(id => id !== postId); history.unshift(postId); if (history.length > 50) history.pop(); HistoryManager.save(history); } };
      let state = { posts: [], currentCategory: '', searchQuery: '', isLoading: true, user: null, profile: null, activeChatChannel: null, activeCommentChannel: null, activePostsChannel: null, pushSubscription: null };

      function showNotification(message, type = 'success', duration = 4000) {
          const container = $('#notification-container');
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          const icons = { success: 'fa-check-circle', error: 'fa-times-circle' };
          toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
          container.appendChild(toast);
          setTimeout(() => toast.classList.add('show'), 10);
          setTimeout(() => {
              toast.classList.remove('show');
              toast.classList.add('hide');
              toast.addEventListener('transitionend', () => toast.remove());
          }, duration);
      }

      const authModalWrapper = $('#auth-modal-wrapper');
      const authContainer = $('#auth-container');
      const openAuthModal = () => authModalWrapper.classList.add('open');
      const closeAuthModal = () => authModalWrapper.classList.remove('open');
      
      const requestModalWrapper = $('#request-modal-wrapper');
      const requestContainer = $('#request-container');
      const openRequestModal = () => requestModalWrapper.classList.add('open');
      const closeRequestModal = () => requestModalWrapper.classList.remove('open');

      $('#auth-modal-close').addEventListener('click', closeAuthModal);
      $('#auth-modal-backdrop').addEventListener('click', closeAuthModal);
      $('#request-modal-close').addEventListener('click', closeRequestModal);
      $('#request-modal-backdrop').addEventListener('click', closeRequestModal);

      // --- FUNGSI PUSH NOTIFICATION ---
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      async function registerServiceWorker() {
        if (!('serviceWorker' in navigator)) {
          showNotification('Browser Anda tidak mendukung notifikasi.', 'error');
          return null;
        }
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          console.log('Service Worker terdaftar:', registration);
          return registration;
        } catch (error) {
          console.error('Gagal mendaftarkan Service Worker:', error);
          showNotification('Gagal mendaftarkan Service Worker.', 'error');
          return null;
        }
      }

      async function askNotificationPermission() {
        if (!('Notification' in window)) {
          showNotification('Browser Anda tidak mendukung notifikasi.', 'error');
          return;
        }
        
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
          console.log('Izin notifikasi diberikan.');
          await subscribeUserToPush();
        } else {
          console.log('Izin notifikasi ditolak.');
          showNotification('Anda menolak izin notifikasi.', 'error');
        }
      }

      async function subscribeUserToPush() {
        const registration = await navigator.serviceWorker.ready;
        if (!registration) {
          showNotification('Service Worker tidak siap.', 'error');
          return;
        }

        if (VAPID_PUBLIC_KEY === 'MASUKKAN_VAPID_PUBLIC_KEY_ANDA_DI_SINI') {
            console.error('VAPID_PUBLIC_KEY belum diatur!');
            showNotification('Konfigurasi notifikasi di sisi admin belum selesai.', 'error');
            return;
        }

        try {
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
          });
          
          console.log('Berhasil subscribe:', subscription);
          state.pushSubscription = subscription;
          
          // --- KODE DIPERBAIKI ---
          // Cek apakah penyimpanan ke Supabase berhasil
          const isSaved = await saveSubscriptionToSupabase(subscription);
          
          if (isSaved) {
            // Hanya set ikon hijau JIKA penyimpanan berhasil
            $('#notifications-toggle').classList.add('subscribed');
          }
          // --- AKHIR PERBAIKAN ---

        } catch (error) {
          console.error('Gagal subscribe:', error);
          showNotification('Gagal berlangganan notifikasi.', 'error');
        }
      }

      // --- FUNGSI DIPERBARUI: saveSubscriptionToSupabase ---
      // Sekarang mengembalikan true (sukses) atau false (gagal)
      async function saveSubscriptionToSupabase(subscription) {
        const subData = {
          subscription_details: subscription.toJSON(),
          user_id: state.user ? state.user.id : null,
          role: state.profile ? state.profile.role : null
        };

        let query;
        if (state.user) {
          // Pengguna login: Gunakan upsert untuk update/insert berdasarkan user_id
          query = supabase
            .from('push_subscriptions')
            .upsert(subData, { onConflict: 'user_id' }); 
        } else {
          // Pengguna tamu: Selalu insert. RLS "Allow public insert" akan mengizinkan ini.
          query = supabase
            .from('push_subscriptions')
            .insert(subData);
        }

        const { data, error } = await query;

        if (error) {
          console.error('Gagal menyimpan langganan:', error);
          showNotification('Gagal menyimpan pendaftaran notifikasi.', 'error');
          return false; // <-- KEMBALIKAN false JIKA GAGAL
        } else {
          console.log('Langganan berhasil disimpan:', data);
          showNotification('Anda berhasil berlangganan notifikasi!', 'success');
          return true; // <-- KEMBALIKAN true JIKA SUKSES
        }
      }
      // --- AKHIR FUNGSI DIPERBARUI ---
      
      // --- FUNGSI DIPERBARUI: checkSubscriptionStatus ---
      async function checkSubscriptionStatus() {
        if (!('serviceWorker' in navigator)) return;
        
        try {
          const registration = await navigator.serviceWorker.ready;
          const subscription = await registration.pushManager.getSubscription();
          
          if (subscription) {
            console.log('Pengguna sudah berlangganan (menurut browser).');
            state.pushSubscription = subscription;
            
            // Coba simpan/update ke Supabase
            const isSaved = await saveSubscriptionToSupabase(subscription);
            
            if (isSaved) {
              // HANYA set hijau jika *berhasil* disimpan ke database
              $('#notifications-toggle').classList.add('subscribed'); 
            } else {
              // Jika gagal simpan, jangan tandai sebagai subscribed
              $('#notifications-toggle').classList.remove('subscribed'); 
            }
          } else {
            $('#notifications-toggle').classList.remove('subscribed');
          }
        } catch (error) {
          console.error('Gagal cek status subscription:', error);
        }
      }
      // --- AKHIR FUNGSI DIPERBARUI ---

      const showLoading = (loading) => {
        state.isLoading = loading;
        $('#skeleton-grid').classList.toggle('hidden', !loading);
        $('#post-grid').classList.toggle('hidden', loading);
      };

      const createPostElement = (post) => {
        const el = document.createElement('div');
        el.className = 'post-card';
        el.dataset.postId = post.id;
        const isWishlisted = WishlistManager.has(post.id);
        const isModerator = state.profile?.role === 'admin' || state.profile?.role === 'moderator';
        const adminActionsHTML = isModerator ? `<button class="edit-btn"><i class="fas fa-pencil-alt"></i></button>` : '';
        el.innerHTML = `<div class="post-card-img-wrapper">${adminActionsHTML}<img src="${post.img}" alt="${post.title}" class="post-card-img"><button class="wishlist-btn ${isWishlisted ? 'wishlisted' : ''}"><i class="fa-regular fa-heart"></i><i class="fa-solid fa-heart"></i></button></div><div class="post-card-content"><div class="post-card-category">${post.category}</div><h3 class="post-card-title">${post.title}</h3><p class="post-card-desc">${post.description.substring(0, 80)}...</p></div>`;
        el.addEventListener('click', (e) => { if (!e.target.closest('.wishlist-btn') && !e.target.closest('.edit-btn')) { openPostModal(post); } });
        el.querySelector('.wishlist-btn').addEventListener('click', (e) => { e.stopPropagation(); const btn = e.currentTarget; btn.classList.contains('wishlisted') ? WishlistManager.remove(post.id) : WishlistManager.add(post.id); btn.classList.toggle('wishlisted'); if (['wishlist', 'history'].includes(state.currentCategory)) renderPosts(); });
        const editBtn = el.querySelector('.edit-btn');
        if (editBtn) { editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(post); }); }
        return el;
      };

      const renderPosts = () => {
        const grid = $('#post-grid'); grid.innerHTML = ''; let filteredPosts = [];
        if (state.currentCategory === 'wishlist') { const ids = WishlistManager.get(); filteredPosts = state.posts.filter(p => ids.includes(p.id)); } 
        else if (state.currentCategory === 'history') { const ids = HistoryManager.get(); filteredPosts = ids.map(id => state.posts.find(p => p.id === id)).filter(Boolean); } 
        else if (state.currentCategory === 'featured') { filteredPosts = state.posts.filter(p => p.isFeatured); } 
        else { filteredPosts = state.posts.filter(post => { const query = state.searchQuery.toLowerCase(); const matchesSearch = post.title.toLowerCase().includes(query) || post.description.toLowerCase().includes(query); const matchesCategory = !state.currentCategory || post.category.toLowerCase() === state.currentCategory.toLowerCase(); return matchesSearch && matchesCategory; }); } // perbaikan: toLowerCase() untuk category
        if (filteredPosts.length === 0) { const messages = { wishlist: 'Wishlist Anda kosong.', history: 'Riwayat unduhan kosong.', featured: 'Tidak ada pilihan editor saat ini.' }; grid.innerHTML = `<p style="color: var(--muted); text-align: center; grid-column: 1 / -1;">${messages[state.currentCategory] || 'Tidak ada postingan yang cocok.'}</p>`; } 
        else { filteredPosts.forEach(post => grid.appendChild(createPostElement(post))); }
        const titles = { '': 'Postingan Terbaru', wishlist: 'Wishlist Saya', history: 'Riwayat Unduhan', featured: 'Pilihan Editor', addon: 'Addons', template: 'Templates', texturepack: 'TexturePack', informasi: 'Informasi' }; // perbaikan: tambah title 'informasi'
        $('#page-title').textContent = state.searchQuery ? `Hasil untuk "${state.searchQuery}"` : (titles[state.currentCategory] || 'Postingan');
        $('#skeleton-grid').classList.add('hidden'); $('#post-grid').classList.remove('hidden');
      };
      
      const postModalWrapper = $('#post-modal-wrapper');
      
      async function handleCommentSubmit(e) {
        e.preventDefault();
        const form = e.target; const textarea = form.comment; const content = textarea.value.trim(); const postId = form.dataset.postId;
        if (!content || !state.user) return;
        textarea.value = ''; textarea.disabled = true;
        const { error } = await supabase.from('comments').insert({ content: content, post_id: postId, user_id: state.profile.id });
        textarea.disabled = false;
        if (error) { showNotification('Gagal mengirim komentar: ' + error.message, 'error'); textarea.value = content; }
      }

      function renderCommentUI(postId) {
          const container = $('#comment-form-container');
          if (state.user) {
              const userAvatar = state.profile?.avatar_url || `https://api.dicebear.com/8.x/initials/svg?seed=${state.user.email}`;
              container.innerHTML = `<form id="comment-form" data-post-id="${postId}"><img src="${userAvatar}" alt="Avatar" class="comment-avatar"><textarea name="comment" placeholder="Tulis komentar..." required></textarea><button type="submit"><i class="fas fa-paper-plane"></i></button></form>`;
              $('#comment-form').addEventListener('submit', handleCommentSubmit);
          } else {
              container.innerHTML = `<div id="comment-login-prompt"><i class="fas fa-comments"></i><h3>Login untuk Berkomentar</h3><p><a id="login-to-comment">Login sekarang</a> untuk bergabung dalam diskusi.</p></div>`;
              $('#login-to-comment').addEventListener('click', () => { closePostModal(); handleAuthButtonClick(); });
          }
      }
      
      function timeAgo(date) { const seconds = Math.floor((new Date() - new Date(date)) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " tahun lalu"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " bulan lalu"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " hari lalu"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " jam lalu"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " menit lalu"; return "Baru saja"; }
      function formatChatTimestamp(date) { return new Date(date).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }); }

      function renderComment(comment) {
        const profile = comment.profiles; const author = profile?.nickname || 'Pengguna'; const avatar = profile?.avatar_url || `https://api.dicebear.com/8.x/initials/svg?seed=${author}`; const role = profile?.role || 'user';
        
        const createRoleBadge = (r) => {
            if (!r) return '';
            const rc = r.toLowerCase();
            let displayText = 'User';
            if (rc === 'admin') {
                displayText = 'Owner';
            } else if (rc === 'moderator') {
                displayText = 'Admin';
            }
            return `<span class="role-badge ${rc}">${displayText}</span>`;
        };

        return `<div class="comment-item"><img src="${avatar}" alt="${author}" class="comment-avatar"><div class="comment-content"><div class="comment-header"><span class="comment-author">${author}</span>${createRoleBadge(role)}<span class="comment-date">${timeAgo(comment.created_at)}</span></div><p class="comment-body">${comment.content}</p></div></div>`;
      }
      
      async function listenToComments(postId) {
        if(state.activeCommentChannel) { state.activeCommentChannel.unsubscribe(); }
        state.activeCommentChannel = supabase.channel(`public:comments:post_id=eq.${postId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments', filter: `post_id=eq.${postId}` }, async (payload) => {
                const { data: profileData } = await supabase.from('profiles').select('nickname, avatar_url, role').eq('id', payload.new.user_id).single();
                const newComment = { ...payload.new, profiles: profileData };
                const commentList = $('#comment-list');
                const emptyState = commentList.querySelector('.empty-state');
                if (emptyState) { emptyState.remove(); }
                commentList.insertAdjacentHTML('beforeend', renderComment(newComment));
            })
            .subscribe();
      }
      
      async function loadComments(postId) {
          const list = $('#comment-list'); list.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem 0;">Memuat komentar...</p>';
          const { data, error } = await supabase.from('comments').select('*, profiles(nickname, avatar_url, role)').eq('post_id', postId).order('created_at', { ascending: true });
          if (error) { list.innerHTML = `<p style="color: var(--danger); text-align: center;">Gagal memuat: ${error.message}</p>`; return; }
          if (data.length === 0) { list.innerHTML = '<p class="empty-state" style="color: var(--muted); text-align: center; padding: 1rem 0;">Belum ada komentar.</p>'; }
          else { list.innerHTML = data.map(renderComment).join(''); }
          listenToComments(postId);
      }

      const openPostModal = (post) => {
        $('#post-modal-img').src = post.img; $('#modal-category').textContent = post.category; $('#modal-title').textContent = post.title; $('#modal-desc').textContent = post.description; $('#mediafire-link').href = post.links.mediafire; $('#gofile-link').href = post.links.gofile; const downloadHandler = () => HistoryManager.add(post.id); $$('.btn-download').forEach(btn => { btn.removeEventListener('click', downloadHandler); btn.addEventListener('click', downloadHandler, { once: true }); });
        renderCommentUI(post.id); loadComments(post.id); postModalWrapper.classList.add('open');
      };
      
      const closePostModal = () => {
        postModalWrapper.classList.remove('open');
        if(state.activeCommentChannel) { state.activeCommentChannel.unsubscribe(); state.activeCommentChannel = null; }
      }
      postModalWrapper.querySelector('.modal-backdrop').addEventListener('click', closePostModal);
      postModalWrapper.querySelector('.close-modal').addEventListener('click', closePostModal);
      
      const switchMainView = (view) => {
        $('main').classList.toggle('hidden', view !== 'posts');
        $('#chat-view').classList.toggle('hidden', view !== 'chat');
      };
      
      const updateActiveNav = () => {
          $$('.menu-item').forEach(item => item.classList.remove('active'));
          $$('.nav-item').forEach(item => item.classList.remove('active'));

          if (!$('#chat-view').classList.contains('hidden')) {
              $('#chat-menu-btn').classList.add('active');
          } else {
              const activeItems = $$(`[data-category="${state.currentCategory}"]`);
              activeItems.forEach(item => item.classList.add('active'));
          }
      }

      $('#theme-toggle').onclick = () => { const newTheme = document.documentElement.dataset.theme === 'dark' ? '' : 'dark'; document.documentElement.dataset.theme = newTheme; $('#theme-toggle i').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; localStorage.setItem('luminox_theme', newTheme); };
      $('#menu-toggle').onclick = () => $('#sidebar').classList.add('open') & $('#backdrop').classList.add('active');
      $('#backdrop').onclick = () => $('#sidebar').classList.remove('open') & $('#backdrop').classList.remove('active');
      
      const handleCategoryClick = (e) => {
        if(state.activeChatChannel) { state.activeChatChannel.unsubscribe(); state.activeChatChannel = null; }
        switchMainView('posts');
        state.currentCategory = e.currentTarget.dataset.category;
        state.searchQuery = '';
        $('#header-search-input').value = '';
        $('#app-header').classList.remove('search-active');
        updateActiveNav();
        renderPosts(); 
        if(window.innerWidth < 768) { $('#sidebar').classList.remove('open'); $('#backdrop').classList.remove('active'); } 
      };

      $$('[data-category]').forEach(item => item.addEventListener('click', handleCategoryClick));
      $('#search-toggle').onclick = () => { const header = $('#app-header'); header.classList.toggle('search-active'); if (header.classList.contains('search-active')) $('#header-search-input').focus(); else { state.searchQuery = ''; renderPosts(); } };
      $('#header-search-input').addEventListener('input', (e) => { state.searchQuery = e.target.value; renderPosts(); });
      
      async function getProfile(user) { if (!user) return null; const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single(); if (error) { console.error("Gagal mengambil profil:", error); return null; } return data; }
      function renderAdminForm(postToEdit = null) {
        const isEditing = postToEdit !== null; const title = isEditing ? 'Edit Postingan' : 'Buat Postingan Baru'; const buttonText = isEditing ? 'Simpan Perubahan' : 'Upload Postingan';
        authContainer.innerHTML = `<a href="#" class="admin-nav-link" id="go-to-profile-view">Kembali ke Profil</a><h2>${title}</h2><form id="upload-form" data-editing-id="${isEditing ? postToEdit.id : ''}"><label for="title">Judul:</label><input type="text" id="title" name="title" required value="${isEditing ? postToEdit.title : ''}"><label for="description">Deskripsi:</label><textarea id="description" name="description" rows="4" required>${isEditing ? postToEdit.description : ''}</textarea><label for="category">Kategori:</label><select id="category" name="category" required><option value="Template">Template</option><option value="Addon">Addon</option><option value="TexturePack">TexturePack</option><option value="Informasi">Informasi</option></select><label for="img">URL Gambar:</label><input type="text" id="img" name="img" required value="${isEditing ? postToEdit.img : ''}"><label for="mediafire">Link MediaFire:</label><input type="url" id="mediafire" name="mediafire" required value="${isEditing ? postToEdit.links.mediafire : ''}"><label for="gofile">Link Gofile:</label><input type="url" id="gofile" name="gofile" required value="${isEditing ? postToEdit.links.gofile : ''}"><input type="checkbox" id="isFeatured" name="isFeatured" style="width: auto; margin-bottom: 1rem;"><label for="isFeatured">Jadikan Pilihan Editor?</label><br><button type="submit">${buttonText}</button></form><button id="logout-btn" style="margin-top: 1rem;">Logout</button>`; // Perbaikan: tambah kategori 'Informasi' di form
        if (isEditing) { authContainer.querySelector('#category').value = postToEdit.category; authContainer.querySelector('#isFeatured').checked = postToEdit.isFeatured; }
        authContainer.querySelector('#upload-form').addEventListener('submit', handleSubmit); authContainer.querySelector('#logout-btn').addEventListener('click', handleLogout); $('#go-to-profile-view').addEventListener('click', (e) => { e.preventDefault(); renderProfileView(); });
      }
      async function handleRoleUpdate(userId, newRole) { const { error } = await supabase.from('profiles').update({ role: newRole }).eq('id', userId); if (error) { showNotification(`Gagal mengubah role: ${error.message}`, 'error'); } else { showNotification('Role pengguna berhasil diubah.', 'success'); } }
      async function renderUserManagementView() {
          authContainer.innerHTML = `<a href="#" class="admin-nav-link" id="go-to-profile-view">Kembali ke Profil</a><h2>Kelola Pengguna</h2><div id="user-list-container">Memuat pengguna...</div>`;
          $('#go-to-profile-view').addEventListener('click', (e) => { e.preventDefault(); renderProfileView(); });
          const { data: profiles, error } = await supabase.from('profiles').select('id, nickname, role');
          if (error) { $('#user-list-container').innerHTML = `<p style="color:var(--danger);">Gagal memuat pengguna: ${error.message}</p>`; return; }
          const currentAdminId = state.user.id;
          
          const userListHTML = profiles.map(profile => { const nickname = profile.nickname || 'Tanpa Nickname'; const isCurrentUser = profile.id === currentAdminId; return `<li class="user-management-item"><div class="user-management-info"><span class="nickname">${nickname}</span></div><div class="user-management-role"><select data-user-id="${profile.id}" ${isCurrentUser ? 'disabled' : ''}><option value="user" ${profile.role === 'user' ? 'selected' : ''}>User</option><option value="moderator" ${profile.role === 'moderator' ? 'selected' : ''}>Admin</option><option value="admin" ${profile.role === 'admin' ? 'selected' : ''}>Owner</option></select></div></li>`; }).join('');
          
          $('#user-list-container').innerHTML = `<ul class="user-management-list">${userListHTML}</ul>`;
          $$('.user-management-role select').forEach(select => { select.addEventListener('change', (e) => { const userId = e.target.dataset.userId; const newRole = e.target.value; handleRoleUpdate(userId, newRole); }); });
      }
      async function handleDeleteRequest(e) {
        const requestId = e.target.dataset.id; if (!confirm('Anda yakin ingin menghapus request ini?')) return;
        const { error } = await supabase.from('requests').delete().eq('id', requestId);
        if (error) { showNotification('Gagal menghapus request: ' + error.message, 'error'); } else { showNotification('Request berhasil dihapus.', 'success'); renderRequestManagementView(); }
      }
      async function renderRequestManagementView() {
        authContainer.innerHTML = `<a href="#" class="admin-nav-link" id="go-to-profile-view">Kembali ke Profil</a><h2>Kelola Request Pengguna</h2><div id="request-list-container">Memuat request...</div>`;
        $('#go-to-profile-view').addEventListener('click', (e) => { e.preventDefault(); renderProfileView(); });
        const { data: requests, error } = await supabase.from('requests').select('*, profiles(nickname)').order('created_at', { ascending: false });
        if (error) { $('#request-list-container').innerHTML = `<p style="color:var(--danger);">Gagal memuat request: ${error.message}</p>`; return; }
        if (requests.length === 0) { $('#request-list-container').innerHTML = '<p style="color:var(--muted); text-align:center;">Belum ada request dari pengguna.</p>'; return; }
        const requestListHTML = requests.map(req => { const nickname = req.profiles?.nickname || 'Pengguna Anonim'; const description = req.description || '<em>Tidak ada deskripsi.</em>'; return `<li class="request-management-item"><div class="request-management-header"><h4 class="request-management-title">${req.title}</h4><span class="request-management-category">${req.category}</span></div><p class="request-management-user">Dari: <strong>${nickname}</strong></p><p class="request-management-desc">${description}</p><div class="request-management-actions"><button data-id="${req.id}" class="delete-request-btn delete-btn">Hapus</button></div></li>`; }).join('');
        $('#request-list-container').innerHTML = `<ul class="request-management-list">${requestListHTML}</ul>`;
        $$('.delete-request-btn').forEach(button => { button.addEventListener('click', handleDeleteRequest); });
      }
      const openEditModal = (post) => { renderAdminForm(post); openAuthModal(); };
      async function handleRegister(e) { e.preventDefault(); const email = e.target.email.value; const password = e.target.password.value; const { error } = await supabase.auth.signUp({ email, password }); if (error) { showNotification("Pendaftaran Gagal: " + error.message, 'error'); } else { showNotification('Pendaftaran berhasil! Silakan cek email Anda untuk konfirmasi.', 'success'); renderLoginView(); } }
      function renderLoginView() { authContainer.innerHTML = `<div id="login-view"><h2>Login</h2><form id="login-form"><label for="email">Email:</label><input type="email" id="email" name="email" required autocomplete="email"><label for="password">Password:</label><input type="password" id="password" name="password" required autocomplete="current-password"><button type="submit">Login</button></form><p style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">Belum punya akun? <a href="#" id="show-register">Daftar</a></p></div>`; authContainer.querySelector('#login-form').addEventListener('submit', handleLogin); authContainer.querySelector('#show-register').addEventListener('click', (e) => { e.preventDefault(); renderRegisterView(); }); }
      function renderRegisterView() { authContainer.innerHTML = `<div id="register-view"><h2>Daftar Akun Baru</h2><form id="register-form"><label for="register-email">Email:</label><input type="email" id="register-email" name="email" required autocomplete="email"><label for="register-password">Password:</label><input type="password" id="register-password" name="password" required autocomplete="new-password"><button type="submit">Daftar</button></form><p style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">Sudah punya akun? <a href="#" id="show-login">Login</a></p></div>`; authContainer.querySelector('#register-form').addEventListener('submit', handleRegister); authContainer.querySelector('#show-login').addEventListener('click', (e) => { e.preventDefault(); renderLoginView(); }); }
      async function renderProfileView() {
          const user = state.user; const profile = state.profile;
          if (user && profile) {
              const isModerator = profile.role === 'admin' || profile.role === 'moderator'; const isAdmin = profile.role === 'admin';
              const adminPanelButtonHTML = isModerator ? `<button id="go-to-admin-btn" style="background-color: var(--success);">Panel Admin</button>` : ''; const userManagementButtonHTML = isAdmin ? `<button id="manage-users-btn" style="background-color: var(--accent);">Kelola Pengguna</button>` : ''; const requestManagementButtonHTML = isModerator ? `<button id="manage-requests-btn" style="background-color: #f39c12;">Kelola Request</button>` : '';
              const avatarSrc = profile.avatar_url || `https://api.dicebear.com/8.x/initials/svg?seed=${user.email}`;
              authContainer.innerHTML = `<form id="profile-form"><h2>Profil Saya</h2><div class="profile-header"><div class="profile-avatar-wrapper"><img src="${avatarSrc}" alt="Avatar" class="profile-avatar" id="avatar-preview"><label for="avatar-upload" id="avatar-upload-label"><i class="fas fa-camera"></i></label><input type="file" id="avatar-upload" name="avatar" class="hidden" accept="image/png, image/jpeg"></div></div><label for="nickname">Nickname:</label><input type="text" id="nickname" name="nickname" value="${profile.nickname || ''}" placeholder="Masukkan nickname Anda"><label for="email" style="margin-top:0.5rem;">Email:</label><input type="email" id="email" name="email" value="${user.email}" disabled><button type="submit">Simpan Perubahan</button></form><div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">${adminPanelButtonHTML}${userManagementButtonHTML}${requestManagementButtonHTML}<button id="logout-btn">Logout</button></div>`;
              authContainer.querySelector('#profile-form').addEventListener('submit', handleProfileUpdate); authContainer.querySelector('#logout-btn').addEventListener('click', handleLogout); authContainer.querySelector('#avatar-upload').addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { $('#avatar-preview').src = event.target.result; }; reader.readAsDataURL(file); } });
              if(isModerator) { $('#go-to-admin-btn').addEventListener('click', (e) => { e.preventDefault(); renderAdminForm(); }); $('#manage-requests-btn').addEventListener('click', (e) => { e.preventDefault(); renderRequestManagementView(); }); }
              if(isAdmin) { $('#manage-users-btn').addEventListener('click', (e) => { e.preventDefault(); renderUserManagementView(); }); }
          } else { renderLoginView(); }
      }
      async function handleProfileUpdate(e) {
          e.preventDefault(); const form = e.target; const user = state.user; const newNickname = form.nickname.value; const avatarFile = form.avatar.files[0]; let avatar_url = state.profile.avatar_url;
          if (avatarFile) {
              const fileExt = avatarFile.name.split('.').pop(); const fileName = `${user.id}.${fileExt}`; const filePath = `${fileName}`;
              const { error: uploadError } = await supabase.storage.from('avatars').upload(filePath, avatarFile, { upsert: true }); if (uploadError) { showNotification('Gagal mengunggah foto profil: ' + uploadError.message, 'error'); return; }
              const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filePath); avatar_url = urlData.publicUrl + `?t=${new Date().getTime()}`;
          }
          const { error: updateError } = await supabase.from('profiles').update({ nickname: newNickname, avatar_url: avatar_url }).eq('id', user.id);
          if (updateError) { showNotification('Gagal memperbarui profil: ' + updateError.message, 'error'); } else { showNotification('Profil berhasil diperbarui!', 'success'); state.profile.nickname = newNickname; state.profile.avatar_url = avatar_url; renderProfileView(); }
      }
      async function setupUIBasedOnAuth() {
        const { data: { user } } = await supabase.auth.getUser(); state.user = user;
        if (user) { 
          const profile = await getProfile(user); 
          state.profile = profile; 
          $('#auth-menu-text').textContent = 'Akun Saya'; 
        } else { 
          state.profile = null; 
          $('#auth-menu-text').textContent = 'Login/Register'; 
        }
        await checkSubscriptionStatus(); // Pindahkan ke sini agar dipanggil setelah auth selesai
        renderPosts();
      }
      async function handleLogin(e) {
        e.preventDefault(); const email = e.target.email.value; const password = e.target.password.value;
        const { error, data } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { showNotification("Login Gagal: " + error.message, 'error'); } else { 
          showNotification('Login berhasil!', 'success'); 
          state.user = data.user; 
          state.profile = await getProfile(data.user); 
          await setupUIBasedOnAuth();
          await renderProfileView(); 
        }
      }
      async function handleLogout() { 
        await supabase.auth.signOut(); 
        state.user = null; 
        state.profile = null; 
        await setupUIBasedOnAuth();
        showNotification('Anda telah logout.', 'success'); 
        closeAuthModal(); 
      }
      async function handleSubmit(e) {
        e.preventDefault(); const form = e.target; const editingId = form.dataset.editingId;
        const postData = { title: form.title.value, description: form.description.value, category: form.category.value, isFeatured: form.isFeatured.checked, img: form.img.value, links: { mediafire: form.mediafire.value, gofile: form.gofile.value } };
        const { error } = editingId ? await supabase.from('posts').update(postData).eq('id', editingId) : await supabase.from('posts').insert([postData]);
        if (error) { showNotification('Operasi Gagal: ' + error.message, 'error'); } else { showNotification(`Postingan berhasil ${editingId ? 'diperbarui' : 'diupload'}!`, 'success'); form.reset(); closeAuthModal(); }
      }
      async function fetchPosts() { try { const { data, error } = await supabase.from('posts').select('*').order('created_at', { ascending: false }); if (error) throw error; state.posts = data; renderPosts(); } catch (error) { console.error('Gagal memuat data postingan:', error); $('#post-grid').innerHTML = `<p style="color: var(--muted); text-align: center;">Gagal memuat data. Silakan coba lagi nanti.</p>`; showNotification('Gagal memuat data postingan.', 'error'); } }
      function renderRequestView() {
        if (state.user) { requestContainer.innerHTML = `<h2>Buat Request</h2><p style="font-size: 0.9rem; color: var(--muted); margin-top: -0.5rem; margin-bottom: 1.5rem;">Ingin Addon, Template, atau TexturePack yang kalian mau? Silahkan ajukan request Anda!</p><form id="request-form"><label for="request-title">Nama Item/Game:</label><input type="text" id="request-title" name="title" required placeholder="Contoh: Shader Realistis"><label for="request-category">Kategori:</label><select id="request-category" name="category" required><option value="" disabled selected>Pilih Kategori</option><option value="Addon">Addon</option><option value="Template">Template</option><option value="TexturePack">TexturePack</option><option value="Informasi">Informasi</option></select><label for="request-description">Deskripsi (Opsional):</label><textarea id="request-description" name="description" rows="3" placeholder="Jelaskan lebih detail tentang request Anda..."></textarea><button type="submit">Kirim Request</button></form>`; $('#request-form').addEventListener('submit', handleRequestSubmit); } // Perbaikan: tambah 'Informasi' di request
        else { requestContainer.innerHTML = `<div class="chat-login-prompt"><i class="fas fa-lock"></i><h3>Login Diperlukan</h3><p>Anda harus login terlebih dahulu untuk dapat mengajukan request.</p><button id="login-from-request" style="width: auto; padding: 0.6rem 1.5rem;">Login Sekarang</button></div>`; $('#login-from-request').addEventListener('click', () => { closeRequestModal(); handleAuthButtonClick(); }); }
      }
      async function handleRequestSubmit(e) {
          e.preventDefault(); const form = e.target;
          const requestData = { title: form.title.value, category: form.category.value, description: form.description.value, user_id: state.user.id };
          const { error } = await supabase.from('requests').insert([requestData]);
          if (error) { showNotification('Gagal mengirim request: ' + error.message, 'error'); } else { showNotification('Request Anda berhasil dikirim!', 'success'); closeRequestModal(); }
      }

      function renderChatMessage(message) {
          const profile = message.profiles;
          const author = profile?.nickname || 'Pengguna';
          const avatar = profile?.avatar_url || `https://api.dicebear.com/8.x/initials/svg?seed=${author}`;
          const isCurrentUser = state.user && message.user_id === state.user.id;
          const editedTag = message.updated_at && message.created_at !== message.updated_at ? `<span class="message-edited-tag">(diedit)</span>` : '';

          const messageNode = document.createElement('div');
          messageNode.className = `chat-message ${isCurrentUser ? 'current-user' : ''}`;
          messageNode.dataset.messageId = message.id;
          messageNode.innerHTML = `<img src="${avatar}" alt="${author}" class="message-avatar"><div class="message-content"><div class="message-meta"><span class="message-author">${author}</span><span class="message-timestamp">${formatChatTimestamp(message.created_at)} ${editedTag}</span></div><div class="message-bubble"><p class="message-text">${message.content}</p></div></div>`;
          
          if(isCurrentUser) {
              let pressTimer;
              const bubble = messageNode.querySelector('.message-bubble');
              bubble.addEventListener('mousedown', (e) => { pressTimer = window.setTimeout(() => showMessageContextMenu(e, message), 500); });
              bubble.addEventListener('touchstart', (e) => { pressTimer = window.setTimeout(() => showMessageContextMenu(e, message), 500); });
              bubble.addEventListener('mouseup', () => clearTimeout(pressTimer));
              bubble.addEventListener('mouseleave', () => clearTimeout(pressTimer));
              bubble.addEventListener('touchend', () => clearTimeout(pressTimer));
          }
          return messageNode;
      }
      async function handleChatSubmit(e) {
        e.preventDefault();
        const form = e.target; const input = form.message; const content = input.value.trim();
        if (!content || !state.user) return;
        input.value = '';
        const { error } = await supabase.from('messages').insert({ content, user_id: state.user.id });
        if (error) { console.error("Error sending message:", error); showNotification('Gagal mengirim pesan: ' + error.message, 'error'); input.value = content; }
      }
      async function renderChatView() {
          $('#page-title').textContent = 'Global Chat';
          const chatView = $('#chat-view');
          
          if (!state.user) {
              chatView.innerHTML = `<div class="chat-login-prompt"><i class="fas fa-comments"></i><h3>Login untuk Chat</h3><p>Anda harus login untuk bisa bergabung di chat global.</p><button id="login-from-chat" style="width: auto; padding: 0.6rem 1.5rem;">Login Sekarang</button></div>`;
              $('#login-from-chat').addEventListener('click', handleAuthButtonClick);
              return;
          }

          chatView.innerHTML = `<div id="chat-view-container"><div class="chat-messages" id="chat-messages-container"><p style="text-align:center; color: var(--muted);">Memuat pesan...</p></div><form id="chat-form"><input type="text" name="message" placeholder="Ketik pesan..." autocomplete="off" required><button type="submit" aria-label="Kirim Pesan"><i class="fas fa-paper-plane"></i></button></form></div>`;
          $('#chat-form').addEventListener('submit', handleChatSubmit);

          const messagesContainer = $('#chat-messages-container');
          const scrollToBottom = () => { messagesContainer.scrollTop = messagesContainer.scrollHeight; };
          
          const { data, error } = await supabase.from('messages').select('*, profiles(nickname, avatar_url)').order('created_at').limit(100);
          if (error) { messagesContainer.innerHTML = `<p style="text-align:center; color:var(--danger)">Gagal memuat pesan: ${error.message}</p>`; return; }

          if(data.length === 0) { messagesContainer.innerHTML = `<p class="empty-state" style="text-align:center; color: var(--muted);">Jadilah yang pertama mengirim pesan!</p>`; }
          else { messagesContainer.innerHTML = ''; data.forEach(msg => messagesContainer.appendChild(renderChatMessage(msg))); scrollToBottom(); }
          
          if(state.activeChatChannel) { state.activeChatChannel.unsubscribe(); }

          state.activeChatChannel = supabase.channel('public:messages')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, async (payload) => {
                  const messagesContainer = $('#chat-messages-container');
                  switch (payload.eventType) {
                      case 'INSERT':
                          const { data: profileData } = await supabase.from('profiles').select('nickname, avatar_url').eq('id', payload.new.user_id).single();
                          const emptyState = messagesContainer.querySelector('.empty-state');
                          if (emptyState) { emptyState.remove(); }
                          const messageWithProfile = { ...payload.new, profiles: profileData };
                          messagesContainer.appendChild(renderChatMessage(messageWithProfile));
                          scrollToBottom();
                          break;
                      case 'UPDATE':
                          const updatedMsgNode = $(`[data-message-id="${payload.new.id}"]`);
                          if (updatedMsgNode) {
                              updatedMsgNode.querySelector('.message-text').textContent = payload.new.content;
                              const timestampNode = updatedMsgNode.querySelector('.message-timestamp');
                              if (!timestampNode.querySelector('.message-edited-tag')) {
                                  timestampNode.innerHTML += ' <span class="message-edited-tag">(diedit)</span>';
                              }
                          }
                          break;
                      case 'DELETE':
                          const deletedMsgNode = $(`[data-message-id="${payload.old.id}"]`);
                          if(deletedMsgNode) deletedMsgNode.remove();
                          break;
                  }
              })
              .subscribe();
      }
      
      function listenToPosts() {
          if (state.activePostsChannel) return;
          state.activePostsChannel = supabase.channel('public:posts')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, (payload) => {
                  console.log('Perubahan postingan diterima!', payload);
                  switch (payload.eventType) {
                      case 'INSERT': state.posts.unshift(payload.new); break;
                      case 'UPDATE': const index = state.posts.findIndex(p => p.id === payload.new.id); if (index !== -1) state.posts[index] = payload.new; break;
                      case 'DELETE': state.posts = state.posts.filter(p => p.id !== payload.old.id); break;
                  }
                  renderPosts();
              })
              .subscribe();
      }
      
      const contextMenu = $('#message-context-menu');

      function showMessageContextMenu(e, message) {
          e.preventDefault();
          contextMenu.style.display = 'block';
          const rect = e.target.getBoundingClientRect();
          let top = e.pageY || e.touches[0].pageY;
          let left = e.pageX || e.touches[0].pageX;
          
          contextMenu.style.top = `${top}px`;
          contextMenu.style.left = `${left}px`;
          
          const menuRect = contextMenu.getBoundingClientRect();
          if (menuRect.right > window.innerWidth) {
            contextMenu.style.left = `${window.innerWidth - menuRect.width - 5}px`;
          }
           if (menuRect.bottom > window.innerHeight) {
            contextMenu.style.top = `${window.innerHeight - menuRect.height - 5}px`;
          }

          $('#edit-msg-btn').onclick = () => startEditMessage(message.id);
          $('#delete-msg-btn').onclick = () => deleteMessage(message.id);

          setTimeout(() => { document.addEventListener('click', hideContextMenu, { once: true }); }, 100);
      }

      function hideContextMenu() { contextMenu.style.display = 'none'; }

      async function deleteMessage(messageId) {
          if (confirm('Anda yakin ingin menghapus pesan ini?')) {
              const { error } = await supabase.from('messages').delete().eq('id', messageId);
              if (error) { showNotification('Gagal menghapus pesan: ' + error.message, 'error'); }
          }
      }

      function startEditMessage(messageId) {
          const messageNode = $(`[data-message-id="${messageId}"]`);
          const bubble = messageNode.querySelector('.message-bubble');
          const currentText = messageNode.querySelector('.message-text').textContent;
          
          bubble.innerHTML = `
              <form class="message-edit-form">
                  <textarea required>${currentText}</textarea>
                  <div class="edit-actions">
                      <button type="button" class="cancel-btn">Batal</button>
                      <button type="submit">Simpan</button>
                  </div>
              </form>
          `;
          
          const form = bubble.querySelector('form');
          const textarea = form.querySelector('textarea');
          textarea.focus();
          textarea.setSelectionRange(currentText.length, currentText.length);

          form.querySelector('.cancel-btn').addEventListener('click', () => {
              bubble.innerHTML = `<p class="message-text">${currentText}</p>`;
          });

          form.addEventListener('submit', async (e) => {
              e.preventDefault();
              const newText = textarea.value.trim();
              if (newText && newText !== currentText) {
                  const { error } = await supabase.from('messages').update({ content: newText, updated_at: new Date().toISOString() }).eq('id', messageId);
                  if (error) { showNotification('Gagal mengedit pesan: ' + error.message, 'error'); }
              } else {
                  bubble.innerHTML = `<p class="message-text">${currentText}</p>`;
              }
          });
      }

      const welcomePopup = $('#welcome-popup-wrapper');
      if (welcomePopup) {
          const welcomePopupBackdrop = welcomePopup.querySelector('.popup-backdrop');
          const welcomePopupClose = welcomePopup.querySelector('.popup-close-btn');

          const openWelcomePopup = () => welcomePopup.classList.add('open');
          const closeWelcomePopup = () => {
              welcomePopup.classList.remove('open');
              try {
                  sessionStorage.setItem('luminoxPopupShown', 'true');
              } catch (e) {
                  console.warn('Gagal menyimpan ke sessionStorage:', e);
              }
          };

          welcomePopupClose.addEventListener('click', closeWelcomePopup);
          welcomePopupBackdrop.addEventListener('click', closeWelcomePopup);

          try {
              if (!sessionStorage.getItem('luminoxPopupShown')) {
                  setTimeout(openWelcomePopup, 1000);
              }
          } catch (e) {
              console.warn('Gagal mengakses sessionStorage:', e);
              setTimeout(openWelcomePopup, 1000);
          }
      }


      const init = async () => {
        const savedTheme = localStorage.getItem('luminox_theme') || '';
        if (savedTheme) { document.documentElement.dataset.theme = savedTheme; $('#theme-toggle i').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; }
        const skeletonGrid = $('#skeleton-grid');
        const skeletonCardHTML = `<div class="skeleton-card"><div class="skeleton-img shimmer"></div><div class="skeleton-content"><div class="skeleton-line shimmer" style="width: 35%;"></div><div class="skeleton-line shimmer" style="width: 85%;"></div><div class="skeleton-line shimmer" style="width: 60%;"></div></div></div>`;
        skeletonGrid.innerHTML = Array(4).fill(skeletonCardHTML).join('');
        
        await registerServiceWorker(); // Daftarkan service worker dulu
        await fetchPosts();
        await setupUIBasedOnAuth(); // setupUIBasedOnAuth akan memanggil checkSubscriptionStatus
        listenToPosts();
      };
      
      const handleAuthButtonClick = async () => { if (state.user) { await renderProfileView(); } else { renderLoginView(); } openAuthModal(); };
      const handleRequestButtonClick = () => { renderRequestView(); openRequestModal(); };
      const handleChatButtonClick = () => {
        switchMainView('chat');
        updateActiveNav();
        renderChatView();
        if(window.innerWidth < 768) { $('#sidebar').classList.remove('open'); $('#backdrop').classList.remove('active'); }
      };
      
      $('#auth-menu-btn').addEventListener('click', handleAuthButtonClick);
      $('#auth-bottom-nav-btn').addEventListener('click', handleAuthButtonClick);
      $('#request-menu-btn').addEventListener('click', handleRequestButtonClick);
      $('#chat-menu-btn').addEventListener('click', handleChatButtonClick);
      
      $('#notifications-toggle').addEventListener('click', () => {
        if ($('#notifications-toggle').classList.contains('subscribed')) {
          showNotification('Anda sudah berlangganan notifikasi.', 'success');
        } else {
          askNotificationPermission();
        }
      });
      
      init();
    });
</script>
</body>
</html>
